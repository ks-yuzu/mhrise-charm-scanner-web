var app=function(){"use strict";function t(){}function e(t){return t()}function l(){return Object.create(null)}function s(t){t.forEach(e)}function i(t){return"function"==typeof t}function n(t,e){return t!=t?e==e:t!==e||t&&"object"==typeof t||"function"==typeof t}function a(e,l,s){e.$$.on_destroy.push(function(e,...l){if(null==e)return t;const s=e.subscribe(...l);return s.unsubscribe?()=>s.unsubscribe():s}(l,s))}function m(t,e){t.appendChild(e)}function p(t,e,l){t.insertBefore(e,l||null)}function g(t){t.parentNode.removeChild(t)}function r(t){return document.createElement(t)}function o(t){return document.createTextNode(t)}function c(){return o(" ")}function u(t,e,l,s){return t.addEventListener(e,l,s),()=>t.removeEventListener(e,l,s)}function j(t,e,l){null==l?t.removeAttribute(e):t.getAttribute(e)!==l&&t.setAttribute(e,l)}function h(t,e){e=""+e,t.wholeText!==e&&(t.data=e)}let k;function f(t){k=t}const d=[],v=[],_=[],P=[],w=Promise.resolve();let E=!1;function $(t){_.push(t)}let y=!1;const L=new Set;function b(){if(!y){y=!0;do{for(let t=0;t<d.length;t+=1){const e=d[t];f(e),A(e.$$)}for(f(null),d.length=0;v.length;)v.pop()();for(let t=0;t<_.length;t+=1){const e=_[t];L.has(e)||(L.add(e),e())}_.length=0}while(d.length);for(;P.length;)P.pop()();E=!1,y=!1,L.clear()}}function A(t){if(null!==t.fragment){t.update(),s(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach($)}}const T=new Set;function O(t,e){-1===t.$$.dirty[0]&&(d.push(t),E||(E=!0,w.then(b)),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function S(n,a,m,p,r,o,c=[-1]){const u=k;f(n);const j=n.$$={fragment:null,ctx:null,props:o,update:t,not_equal:r,bound:l(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(u?u.$$.context:a.context||[]),callbacks:l(),dirty:c,skip_bound:!1};let h=!1;if(j.ctx=m?m(n,a.props||{},((t,e,...l)=>{const s=l.length?l[0]:e;return j.ctx&&r(j.ctx[t],j.ctx[t]=s)&&(!j.skip_bound&&j.bound[t]&&j.bound[t](s),h&&O(n,t)),e})):[],j.update(),h=!0,s(j.before_update),j.fragment=!!p&&p(j.ctx),a.target){if(a.hydrate){const t=function(t){return Array.from(t.childNodes)}(a.target);j.fragment&&j.fragment.l(t),t.forEach(g)}else j.fragment&&j.fragment.c();a.intro&&((d=n.$$.fragment)&&d.i&&(T.delete(d),d.i(v))),function(t,l,n,a){const{fragment:m,on_mount:p,on_destroy:g,after_update:r}=t.$$;m&&m.m(l,n),a||$((()=>{const l=p.map(e).filter(i);g?g.push(...l):s(l),t.$$.on_mount=[]})),r.forEach($)}(n,a.target,a.anchor,a.customElement),b()}var d,v;f(u)}function R(t){return new Promise((e=>{const l=new Image;l.src=t,l.onload=()=>{const t=cv.imread(l);e(t)}}))}function I(t,e,l,s,i){const n=new cv.Size(e.cols,e.rows),a=new cv.Rect(l,n),m=t.roi(a),p=new cv.Mat;cv.threshold(e,p,s,255,cv.THRESH_BINARY);const g=new cv.Mat;m.copyTo(g,p);const r=new cv.Mat;cv.absdiff(e,g,r),cv.cvtColor(r,r,cv.COLOR_BGR2GRAY);const o=new cv.Mat;return cv.threshold(r,o,i,255,cv.THRESH_BINARY),r.delete(),g.delete(),p.delete(),m.delete(),o}function C(t,e,l,s=63,i=63){let n=Number.MAX_SAFE_INTEGER,a=null;for(const[m,p]of Object.entries(e)){const e=I(t,p,l,s,i),g=cv.countNonZero(e);n>g&&(n=g,a=m),e.delete()}return a}function M(t){return t instanceof Promise?t:Array.isArray(t)?Promise.all(t.map(M)):"object"==typeof t?function(t){const e=Object.keys(t).map((e=>M(t[e]).then((t=>({key:e,value:t})))));return Promise.all(e).then((t=>t.reduce(((t,e)=>(t[e.key]=e.value,t)),{})))}(t):Promise.resolve(t)}class N{MAX_PAGE=34;COLUMNS_PER_PAGE=10;ROWS_PER_PAGE=5;POINT_RARITY=new cv.Point(1190,176);POINT_SLOTS=new cv.Point(1160,200);POINT_SKILL1=new cv.Point(1033,266);POINT_SKILL2=new cv.Point(1033,317);POINT_SKILL_LEVEL1=new cv.Point(1190,289);POINT_SKILL_LEVEL2=new cv.Point(1190,340);POINT_PAGE=new cv.Point(787,582);POINT_CHARM_AREA_LEFT_TOP=new cv.Point(634,359);SIZE_CHARM_AREA=new cv.Size(357,199);nCharms=0;charms={};templates=null;async init(){this.templates={frame:R("img/templates/frame.png"),rare:{7:R("img/templates/rare/7.jpg"),6:R("img/templates/rare/6.jpg"),5:R("img/templates/rare/5.jpg"),4:R("img/templates/rare/4.jpg")},lvl:{0:R("img/templates/lvl/0.jpg"),1:R("img/templates/lvl/1.jpg"),2:R("img/templates/lvl/2.jpg"),3:R("img/templates/lvl/3.jpg"),4:R("img/templates/lvl/4.jpg"),5:R("img/templates/lvl/5.jpg")},slot:{"0-0-0":R("img/templates/slot/0.jpg"),"1-0-0":R("img/templates/slot/1.jpg"),"1-1-0":R("img/templates/slot/11.jpg"),"1-1-1":R("img/templates/slot/111.jpg"),"2-0-0":R("img/templates/slot/2.jpg"),"2-1-0":R("img/templates/slot/21.jpg"),"2-1-1":R("img/templates/slot/211.jpg"),"2-2-0":R("img/templates/slot/22.jpg"),"2-2-1":R("img/templates/slot/221.jpg"),"3-0-0":R("img/templates/slot/3.jpg"),"3-1-0":R("img/templates/slot/31.jpg"),"3-1-1":R("img/templates/slot/311.jpg"),"3-2-0":R("img/templates/slot/32.jpg"),"3-2-1":R("img/templates/slot/321.jpg")},skill:{"KO術":R("img/templates/skill/KO術.jpg"),"匠":R("img/templates/skill/匠.jpg"),"不屈":R("img/templates/skill/不屈.jpg"),"体術":R("img/templates/skill/体術.jpg"),"幸運":R("img/templates/skill/幸運.jpg"),"心眼":R("img/templates/skill/心眼.jpg"),"攻撃":R("img/templates/skill/攻撃.jpg"),"業物":R("img/templates/skill/業物.jpg"),"渾身":R("img/templates/skill/渾身.jpg"),"無し":R("img/templates/skill/無し.jpg"),"砲術":R("img/templates/skill/砲術.jpg"),"耐震":R("img/templates/skill/耐震.jpg"),"耳栓":R("img/templates/skill/耳栓.jpg"),"逆襲":R("img/templates/skill/逆襲.jpg"),"防御":R("img/templates/skill/防御.jpg"),"陽動":R("img/templates/skill/陽動.jpg"),"集中":R("img/templates/skill/集中.jpg"),"ボマー":R("img/templates/skill/ボマー.jpg"),"地質学":R("img/templates/skill/地質学.jpg"),"広域化":R("img/templates/skill/広域化.jpg"),"挑戦者":R("img/templates/skill/挑戦者.jpg"),"早食い":R("img/templates/skill/早食い.jpg"),"植生学":R("img/templates/skill/植生学.jpg"),"毒耐性":R("img/templates/skill/毒耐性.jpg"),"水耐性":R("img/templates/skill/水耐性.jpg"),"氷耐性":R("img/templates/skill/氷耐性.jpg"),"満足感":R("img/templates/skill/満足感.jpg"),"火耐性":R("img/templates/skill/火耐性.jpg"),"破壊王":R("img/templates/skill/破壊王.jpg"),"納刀術":R("img/templates/skill/納刀術.jpg"),"見切り":R("img/templates/skill/見切り.jpg"),"超会心":R("img/templates/skill/超会心.jpg"),"逆恨み":R("img/templates/skill/逆恨み.jpg"),"達人芸":R("img/templates/skill/達人芸.jpg"),"雷耐性":R("img/templates/skill/雷耐性.jpg"),"鬼火纏":R("img/templates/skill/鬼火纏.jpg"),"龍耐性":R("img/templates/skill/龍耐性.jpg"),"ブレ抑制":R("img/templates/skill/ブレ抑制.jpg"),"ランナー":R("img/templates/skill/ランナー.jpg"),"乗り名人":R("img/templates/skill/乗り名人.jpg"),"剛刃研磨":R("img/templates/skill/剛刃研磨.jpg"),"力の解放":R("img/templates/skill/力の解放.jpg"),"反動軽減":R("img/templates/skill/反動軽減.jpg"),"回復速度":R("img/templates/skill/回復速度.jpg"),"回避性能":R("img/templates/skill/回避性能.jpg"),"壁面移動":R("img/templates/skill/壁面移動.jpg"),"弱点特効":R("img/templates/skill/弱点特効.jpg"),"強化持続":R("img/templates/skill/強化持続.jpg"),"弾丸節約":R("img/templates/skill/弾丸節約.jpg"),"弾導強化":R("img/templates/skill/弾導強化.jpg"),"死中に活":R("img/templates/skill/死中に活.jpg"),"気絶耐性":R("img/templates/skill/気絶耐性.jpg"),"泡沫の舞":R("img/templates/skill/泡沫の舞.jpg"),"泥雪耐性":R("img/templates/skill/泥雪耐性.jpg"),"滑走強化":R("img/templates/skill/滑走強化.jpg"),"火事場力":R("img/templates/skill/火事場力.jpg"),"睡眠耐性":R("img/templates/skill/睡眠耐性.jpg"),"砲弾装填":R("img/templates/skill/砲弾装填.jpg"),"翔蟲使い":R("img/templates/skill/翔蟲使い.jpg"),"装填拡張":R("img/templates/skill/装填拡張.jpg"),"装填速度":R("img/templates/skill/装填速度.jpg"),"速射強化":R("img/templates/skill/速射強化.jpg"),"鈍器使い":R("img/templates/skill/鈍器使い.jpg"),"風圧耐性":R("img/templates/skill/風圧耐性.jpg"),"飛び込み":R("img/templates/skill/飛び込み.jpg"),"高速変形":R("img/templates/skill/高速変形.jpg"),"麻痺耐性":R("img/templates/skill/麻痺耐性.jpg"),"回避距離UP":R("img/templates/skill/回避距離UP.jpg"),"ひるみ軽減":R("img/templates/skill/ひるみ軽減.jpg"),"ガード強化":R("img/templates/skill/ガード強化.jpg"),"ガード性能":R("img/templates/skill/ガード性能.jpg"),"攻めの守勢":R("img/templates/skill/攻めの守勢.jpg"),"毒属性強化":R("img/templates/skill/毒属性強化.jpg"),"笛吹き名人":R("img/templates/skill/笛吹き名人.jpg"),"精霊の加護":R("img/templates/skill/精霊の加護.jpg"),"腹減り耐性":R("img/templates/skill/腹減り耐性.jpg"),"体力回復量UP":R("img/templates/skill/体力回復量UP.jpg"),"キノコ大好き":R("img/templates/skill/キノコ大好き.jpg"),"ジャンプ鉄人":R("img/templates/skill/ジャンプ鉄人.jpg"),"スタミナ奪取":R("img/templates/skill/スタミナ奪取.jpg"),"フルチャージ":R("img/templates/skill/フルチャージ.jpg"),"剥ぎ取り鉄人":R("img/templates/skill/剥ぎ取り鉄人.jpg"),"抜刀術【力】":R("img/templates/skill/抜刀術【力】.jpg"),"抜刀術【技】":R("img/templates/skill/抜刀術【技】.jpg"),"爆破属性強化":R("img/templates/skill/爆破属性強化.jpg"),"特殊射撃強化":R("img/templates/skill/特殊射撃強化.jpg"),"睡眠属性強化":R("img/templates/skill/睡眠属性強化.jpg"),"麻痺属性強化":R("img/templates/skill/麻痺属性強化.jpg"),"会心撃【属性】":R("img/templates/skill/会心撃【属性】.jpg"),"属性やられ耐性":R("img/templates/skill/属性やられ耐性.jpg"),"水属性攻撃強化":R("img/templates/skill/水属性攻撃強化.jpg"),"氷属性攻撃強化":R("img/templates/skill/氷属性攻撃強化.jpg"),"火属性攻撃強化":R("img/templates/skill/火属性攻撃強化.jpg"),"爆破やられ耐性":R("img/templates/skill/爆破やられ耐性.jpg"),"砥石使用高速化":R("img/templates/skill/砥石使用高速化.jpg"),"雷属性攻撃強化":R("img/templates/skill/雷属性攻撃強化.jpg"),"龍属性攻撃強化":R("img/templates/skill/龍属性攻撃強化.jpg"),"アイテム使用強化":R("img/templates/skill/アイテム使用強化.jpg"),"スタミナ急速回復":R("img/templates/skill/スタミナ急速回復.jpg"),"散弾・拡散矢強化":R("img/templates/skill/散弾・拡散矢強化.jpg"),"貫通弾・貫通矢強化":R("img/templates/skill/貫通弾・貫通矢強化.jpg"),"通常弾・連射矢強化":R("img/templates/skill/通常弾・連射矢強化.jpg")}},this.templates.page={};for(let t=1;t<=this.MAX_PAGE;t++)this.templates.page[t]=R(`img/templates/page/${t}.png`);this.templates=await M(this.templates),this.reset()}reset(){this.nCharms=0,this.charms={};for(let t=1;t<=this.MAX_PAGE;t++){this.charms[t]={};for(let e=1;e<=this.ROWS_PER_PAGE;e++)this.charms[t][e]={}}}isScaned(t,e,l){return null!=this.charms[t][e][l]}store(t){const{page:e,row:l,col:s}=t;this.charms[e][l][s]=t,this.nCharms++}scan(t){const e=this._getCurrentPage(t),[l,s]=this._getCurrentCharmPos(t);if(s<.35)return null;const[i,n]=l;if(this.isScaned(e,n,i))return null;const a=this._getRarity(t),m=this._getSlots(t),p=this._getSkills(t),g=this._getSkillLevels(t);console.log(`scaned ${n} ${i}`),this.store({page:e,row:n,col:i,rarity:a,slots:m,skills:p,skillLevels:g})}countCharms(){return this.nCharms}generateInsertScript(){const t=[];for(let e=1;e<=this.MAX_PAGE;e++)for(let l=1;l<=this.ROWS_PER_PAGE;l++)for(let s=1;s<=this.COLUMNS_PER_PAGE;s++){const i=this.charms[e][l][s];null!=i&&t.push({"第一スキル":i.skills[0],"第一スキルポイント":i.skillLevels[0],"第二スキル":i.skills[1],"第二スキルポイント":i.skillLevels[1],"スロット":i.slots})}return`const inputs = ${JSON.stringify(t)}\n\neval( await (await fetch('https://code.jquery.com/jquery-3.6.0.slim.min.js')).text() )\n\nfor (const input of inputs) {\n  Object.entries(input).forEach(([key, value]) => {\n    $(\`select[aria-label="\${key}"]\`).val(value)\n    $(\`select[aria-label="\${key}"]\`)[0].dispatchEvent(new Event('change', { bubbles: true }))\n  })\n\n  $('button:contains("追加")').click()\n}`}_getRarity(t){return C(t,this.templates.rare,this.POINT_RARITY,63,63)}_getSlots(t){return C(t,this.templates.slot,this.POINT_SLOTS,0,63)}_getSkills(t){return[C(t,this.templates.skill,this.POINT_SKILL1,0,63),C(t,this.templates.skill,this.POINT_SKILL2,0,63)]}_getSkillLevels(t){return[C(t,this.templates.lvl,this.POINT_SKILL_LEVEL1,0,63),C(t,this.templates.lvl,this.POINT_SKILL_LEVEL2,0,63)]}_getCurrentPage(t){return C(t,this.templates.page,this.POINT_PAGE,31,63)}_getCurrentCharmPos(t){const e=new cv.Rect(this.POINT_CHARM_AREA_LEFT_TOP,this.SIZE_CHARM_AREA),l=t.roi(e),s=new cv.Mat;cv.matchTemplate(l,this.templates.frame,s,cv.TM_CCOEFF_NORMED);const{maxLoc:i,maxVal:n}=cv.minMaxLoc(s);return s.delete(),l.delete(),[[1+Math.floor(.5+i.x/36),1+Math.floor(.5+i.y/41)],n]}}const x=[];function G(t){let e,l,s,i,n,a,u,k,f,d,v=Math.floor(100*t[9])+"";return{c(){e=r("div"),l=r("video"),s=r("track"),n=c(),a=r("div"),u=r("progress"),k=c(),f=o(v),d=o("%"),j(s,"kind","captions"),j(l,"class","preview svelte-5a7mj7"),l.src!==(i=t[5])&&j(l,"src",i),j(l,"alt","preview"),u.value=t[9],j(u,"class","svelte-5a7mj7"),j(e,"id","status"),j(e,"class","svelte-5a7mj7")},m(i,g){p(i,e,g),m(e,l),m(l,s),t[12](l),m(e,n),m(e,a),m(a,u),m(a,k),m(a,f),m(a,d)},p(t,e){32&e&&l.src!==(i=t[5])&&j(l,"src",i),512&e&&(u.value=t[9]),512&e&&v!==(v=Math.floor(100*t[9])+"")&&h(f,v)},d(l){l&&g(e),t[12](null)}}}function H(e){let l;return{c(){l=r("div"),l.textContent="Loading Files..."},m(t,e){p(t,l,e)},p:t,d(t){t&&g(l)}}}function K(e){let l,i,n,a,o,h,k,f,d;return{c(){var t,e,s;l=r("div"),i=r("input"),n=c(),a=r("img"),h=c(),k=r("div"),k.textContent="Choose Movie",t="display",e="none",i.style.setProperty(t,e,s?"important":""),j(i,"type","file"),j(i,"accept",".mp4"),j(i,"class","svelte-5a7mj7"),a.src!==(o="https://static.thenounproject.com/png/625182-200.png")&&j(a,"src","https://static.thenounproject.com/png/625182-200.png"),j(a,"alt",""),j(a,"class","svelte-5a7mj7"),j(k,"class","svelte-5a7mj7"),j(l,"id","upload"),j(l,"class","svelte-5a7mj7")},m(t,s){p(t,l,s),m(l,i),e[15](i),m(l,n),m(l,a),m(l,h),m(l,k),f||(d=[u(i,"change",e[13]),u(i,"change",e[14]),u(a,"click",e[16]),u(k,"click",e[17])],f=!0)},p:t,d(t){t&&g(l),e[15](null),f=!1,s(d)}}}function U(t){let e,l,s,i,n;return{c(){e=r("div"),l=o(t[6]),s=o(" charms are scanned."),i=c(),n=r("textarea"),n.value=t[8],j(n,"class","svelte-5a7mj7")},m(a,g){p(a,e,g),m(e,l),m(e,s),p(a,i,g),p(a,n,g),t[18](n)},p(t,e){64&e&&h(l,t[6]),256&e&&(n.value=t[8])},d(l){l&&g(e),l&&g(i),l&&g(n),t[18](null)}}}function F(e){let l,s,i,n,a,o,u,h,k=e[5]&&G(e);function f(t,e){return t[0]?K:H}let d=f(e),v=d(e),_=e[1]&&U(e);return{c(){l=r("main"),s=r("h1"),s.textContent=`${V}`,i=c(),n=r("div"),n.innerHTML='モンスターハンターライズの護石を自動読み取りするツールです。<br/>\n   Nintendo Switch の 30 秒キャプチャ動画を用意するだけで, 護石のスキルやスロットが読み取れます。\n   (<a href="sample/input.mp4">動画例</a>)<br/> \n   <br/>\n   現時点での出力形式は、スキルシミュレータへの登録スクリプトのみです。<br/>',a=c(),k&&k.c(),o=c(),v.c(),u=c(),h=r("div"),_&&_.c(),j(s,"class","svelte-5a7mj7"),j(n,"id","description"),j(n,"class","svelte-5a7mj7"),j(h,"id","result"),j(h,"class","svelte-5a7mj7"),j(l,"class","svelte-5a7mj7")},m(t,e){p(t,l,e),m(l,s),m(l,i),m(l,n),m(l,a),k&&k.m(l,null),m(l,o),v.m(l,null),m(l,u),m(l,h),_&&_.m(h,null)},p(t,[e]){t[5]?k?k.p(t,e):(k=G(t),k.c(),k.m(l,o)):k&&(k.d(1),k=null),d===(d=f(t))&&v?v.p(t,e):(v.d(1),v=d(t),v&&(v.c(),v.m(l,u))),t[1]?_?_.p(t,e):(_=U(t),_.c(),_.m(h,null)):_&&(_.d(1),_=null)},i:t,o:t,d(t){t&&g(l),k&&k.d(),v.d(),_&&_.d()}}}const V="MHRise Charm Scanner";function X(e,l,s){let i,m,p,g,r,o,c,u,j,h,k=!1,f=!1;const d=function(e,l=t){let s;const i=[];function a(t){if(n(e,t)&&(e=t,s)){const t=!x.length;for(let t=0;t<i.length;t+=1){const l=i[t];l[1](),x.push(l,e)}if(t){for(let t=0;t<x.length;t+=2)x[t][0](x[t+1]);x.length=0}}}return{set:a,update:function(t){a(t(e))},subscribe:function(n,m=t){const p=[n,m];return i.push(p),1===i.length&&(s=l(a)||t),n(e),()=>{const t=i.indexOf(p);-1!==t&&i.splice(t,1),0===i.length&&(s(),s=null)}}}}(0);a(e,d,(t=>s(9,i=t)));const _=async t=>{const e=t.target.files;if(e&&e[0]){const t=new FileReader;t.readAsDataURL(e[0]),await new Promise((e=>{t.onload=e})),s(5,o=t.result),await new Promise((t=>setTimeout(t,50))),s(4,r.width=1280,r),s(4,r.height=720,r),await new Promise((t=>r.addEventListener("canplay",t))),c=new cv.VideoCapture(r);const l=new cv.Mat(720,1280,cv.CV_8UC4);await new Promise((t=>setTimeout(t,200)));const i=29.97;for(;r.duration!=r.currentTime;)c.read(l),m.scan(l),P(r,1,i),d.set(r.currentTime/r.duration),await new Promise((t=>setTimeout(t,100)));d.set(1),console.log(m.charms),s(1,f=!0),l.delete()}s(6,u=m.countCharms()),s(8,h=m.generateInsertScript())};window.addEventListener("load",(async()=>{m=new N,await m.init(),s(0,k=!0)}));const P=(t,e,l=29.97)=>{const s=1e-5+(t.currentTime*l+e)/l;t.currentTime=Math.min(t.duration,s)};return[k,f,p,g,r,o,u,j,h,i,d,_,function(t){v[t?"unshift":"push"]((()=>{r=t,s(4,r)}))},t=>_(t),function(){g=this.files,s(3,g)},function(t){v[t?"unshift":"push"]((()=>{p=t,s(2,p)}))},()=>{p.click()},()=>{p.click()},function(t){v[t?"unshift":"push"]((()=>{j=t,s(7,j)}))}]}return new class extends class{$destroy(){!function(t,e){const l=t.$$;null!==l.fragment&&(s(l.on_destroy),l.fragment&&l.fragment.d(e),l.on_destroy=l.fragment=null,l.ctx=[])}(this,1),this.$destroy=t}$on(t,e){const l=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return l.push(e),()=>{const t=l.indexOf(e);-1!==t&&l.splice(t,1)}}$set(t){var e;this.$$set&&(e=t,0!==Object.keys(e).length)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}{constructor(t){super(),S(this,t,X,F,n,{})}}({target:document.body,props:{}})}();
//# sourceMappingURL=bundle.js.map
