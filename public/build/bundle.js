var app=function(){"use strict";function t(){}function e(t){return t()}function l(){return Object.create(null)}function s(t){t.forEach(e)}function i(t){return"function"==typeof t}function n(t,e){return t!=t?e==e:t!==e||t&&"object"==typeof t||"function"==typeof t}function m(e,l,s){e.$$.on_destroy.push(function(e,...l){if(null==e)return t;const s=e.subscribe(...l);return s.unsubscribe?()=>s.unsubscribe():s}(l,s))}function a(t,e){t.appendChild(e)}function p(t,e,l){t.insertBefore(e,l||null)}function g(t){t.parentNode.removeChild(t)}function c(t){return document.createElement(t)}function r(t){return document.createTextNode(t)}function o(){return r(" ")}function u(t,e,l,s){return t.addEventListener(e,l,s),()=>t.removeEventListener(e,l,s)}function h(t,e,l){null==l?t.removeAttribute(e):t.getAttribute(e)!==l&&t.setAttribute(e,l)}function j(t,e){e=""+e,t.wholeText!==e&&(t.data=e)}let k;function f(t){k=t}const d=[],v=[],_=[],P=[],w=Promise.resolve();let E=!1;function $(t){_.push(t)}let y=!1;const L=new Set;function A(){if(!y){y=!0;do{for(let t=0;t<d.length;t+=1){const e=d[t];f(e),b(e.$$)}for(f(null),d.length=0;v.length;)v.pop()();for(let t=0;t<_.length;t+=1){const e=_[t];L.has(e)||(L.add(e),e())}_.length=0}while(d.length);for(;P.length;)P.pop()();E=!1,y=!1,L.clear()}}function b(t){if(null!==t.fragment){t.update(),s(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach($)}}const O=new Set;function T(t,e){-1===t.$$.dirty[0]&&(d.push(t),E||(E=!0,w.then(A)),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function S(n,m,a,p,c,r,o=[-1]){const u=k;f(n);const h=n.$$={fragment:null,ctx:null,props:r,update:t,not_equal:c,bound:l(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(u?u.$$.context:m.context||[]),callbacks:l(),dirty:o,skip_bound:!1};let j=!1;if(h.ctx=a?a(n,m.props||{},((t,e,...l)=>{const s=l.length?l[0]:e;return h.ctx&&c(h.ctx[t],h.ctx[t]=s)&&(!h.skip_bound&&h.bound[t]&&h.bound[t](s),j&&T(n,t)),e})):[],h.update(),j=!0,s(h.before_update),h.fragment=!!p&&p(h.ctx),m.target){if(m.hydrate){const t=function(t){return Array.from(t.childNodes)}(m.target);h.fragment&&h.fragment.l(t),t.forEach(g)}else h.fragment&&h.fragment.c();m.intro&&((d=n.$$.fragment)&&d.i&&(O.delete(d),d.i(v))),function(t,l,n,m){const{fragment:a,on_mount:p,on_destroy:g,after_update:c}=t.$$;a&&a.m(l,n),m||$((()=>{const l=p.map(e).filter(i);g?g.push(...l):s(l),t.$$.on_mount=[]})),c.forEach($)}(n,m.target,m.anchor,m.customElement),A()}var d,v;f(u)}function x(t){return new Promise((e=>{const l=new Image;l.src=t,l.onload=()=>{const t=cv.imread(l);e(t)}}))}function R(t,e,l,s,i){const n=new cv.Size(e.cols,e.rows),m=new cv.Rect(l,n),a=t.roi(m),p=new cv.Mat;cv.threshold(e,p,s,255,cv.THRESH_BINARY);const g=new cv.Mat;a.copyTo(g,p);const c=new cv.Mat;cv.absdiff(e,g,c),cv.cvtColor(c,c,cv.COLOR_BGR2GRAY);const r=new cv.Mat;return cv.threshold(c,r,i,255,cv.THRESH_BINARY),c.delete(),g.delete(),p.delete(),a.delete(),r}function I(t,e,l,s=63,i=63){let n=Number.MAX_SAFE_INTEGER,m=null;for(const[a,p]of Object.entries(e)){const e=R(t,p,l,s,i),g=cv.countNonZero(e);n>g&&(n=g,m=a),e.delete()}return m}function C(t){return t instanceof Promise?t:Array.isArray(t)?Promise.all(t.map(C)):"object"==typeof t?function(t){const e=Object.keys(t).map((e=>C(t[e]).then((t=>({key:e,value:t})))));return Promise.all(e).then((t=>t.reduce(((t,e)=>(t[e.key]=e.value,t)),{})))}(t):Promise.resolve(t)}class M{MAX_PAGE=34;COLUMNS_PER_PAGE=10;ROWS_PER_PAGE=5;POINT_RARITY=new cv.Point(1190,176);POINT_SLOTS=new cv.Point(1160,200);POINT_SKILL1=new cv.Point(1033,266);POINT_SKILL2=new cv.Point(1033,317);POINT_SKILL_LEVEL1=new cv.Point(1190,289);POINT_SKILL_LEVEL2=new cv.Point(1190,340);POINT_PAGE=new cv.Point(787,582);POINT_CHARM_AREA_LEFT_TOP=new cv.Point(634,359);SIZE_CHARM_AREA=new cv.Size(357,199);nCharms=0;charms={};templates=null;async init(){this.templates={frame:x("img/templates/frame.png"),rare:{7:x("img/templates/rare/7.jpg"),6:x("img/templates/rare/6.jpg"),5:x("img/templates/rare/5.jpg"),4:x("img/templates/rare/4.jpg")},lvl:{0:x("img/templates/lvl/0.jpg"),1:x("img/templates/lvl/1.jpg"),2:x("img/templates/lvl/2.jpg"),3:x("img/templates/lvl/3.jpg"),4:x("img/templates/lvl/4.jpg"),5:x("img/templates/lvl/5.jpg")},slot:{"0-0-0":x("img/templates/slot/0.jpg"),"1-0-0":x("img/templates/slot/1.jpg"),"1-1-0":x("img/templates/slot/11.jpg"),"1-1-1":x("img/templates/slot/111.jpg"),"2-0-0":x("img/templates/slot/2.jpg"),"2-1-0":x("img/templates/slot/21.jpg"),"2-1-1":x("img/templates/slot/211.jpg"),"2-2-0":x("img/templates/slot/22.jpg"),"2-2-1":x("img/templates/slot/221.jpg"),"3-0-0":x("img/templates/slot/3.jpg"),"3-1-0":x("img/templates/slot/31.jpg"),"3-1-1":x("img/templates/slot/311.jpg"),"3-2-0":x("img/templates/slot/32.jpg"),"3-2-1":x("img/templates/slot/321.jpg")},skill:{"KO術":x("img/templates/skill/KO術.jpg"),"匠":x("img/templates/skill/匠.jpg"),"不屈":x("img/templates/skill/不屈.jpg"),"体術":x("img/templates/skill/体術.jpg"),"幸運":x("img/templates/skill/幸運.jpg"),"心眼":x("img/templates/skill/心眼.jpg"),"攻撃":x("img/templates/skill/攻撃.jpg"),"業物":x("img/templates/skill/業物.jpg"),"渾身":x("img/templates/skill/渾身.jpg"),"無し":x("img/templates/skill/無し.jpg"),"砲術":x("img/templates/skill/砲術.jpg"),"耐震":x("img/templates/skill/耐震.jpg"),"耳栓":x("img/templates/skill/耳栓.jpg"),"逆襲":x("img/templates/skill/逆襲.jpg"),"防御":x("img/templates/skill/防御.jpg"),"陽動":x("img/templates/skill/陽動.jpg"),"集中":x("img/templates/skill/集中.jpg"),"ボマー":x("img/templates/skill/ボマー.jpg"),"地質学":x("img/templates/skill/地質学.jpg"),"広域化":x("img/templates/skill/広域化.jpg"),"挑戦者":x("img/templates/skill/挑戦者.jpg"),"早食い":x("img/templates/skill/早食い.jpg"),"植生学":x("img/templates/skill/植生学.jpg"),"毒耐性":x("img/templates/skill/毒耐性.jpg"),"水耐性":x("img/templates/skill/水耐性.jpg"),"氷耐性":x("img/templates/skill/氷耐性.jpg"),"満足感":x("img/templates/skill/満足感.jpg"),"火耐性":x("img/templates/skill/火耐性.jpg"),"破壊王":x("img/templates/skill/破壊王.jpg"),"納刀術":x("img/templates/skill/納刀術.jpg"),"見切り":x("img/templates/skill/見切り.jpg"),"超会心":x("img/templates/skill/超会心.jpg"),"逆恨み":x("img/templates/skill/逆恨み.jpg"),"達人芸":x("img/templates/skill/達人芸.jpg"),"雷耐性":x("img/templates/skill/雷耐性.jpg"),"鬼火纏":x("img/templates/skill/鬼火纏.jpg"),"龍耐性":x("img/templates/skill/龍耐性.jpg"),"ブレ抑制":x("img/templates/skill/ブレ抑制.jpg"),"ランナー":x("img/templates/skill/ランナー.jpg"),"乗り名人":x("img/templates/skill/乗り名人.jpg"),"剛刃研磨":x("img/templates/skill/剛刃研磨.jpg"),"力の解放":x("img/templates/skill/力の解放.jpg"),"反動軽減":x("img/templates/skill/反動軽減.jpg"),"回復速度":x("img/templates/skill/回復速度.jpg"),"回避性能":x("img/templates/skill/回避性能.jpg"),"壁面移動":x("img/templates/skill/壁面移動.jpg"),"弱点特効":x("img/templates/skill/弱点特効.jpg"),"強化持続":x("img/templates/skill/強化持続.jpg"),"弾丸節約":x("img/templates/skill/弾丸節約.jpg"),"弾導強化":x("img/templates/skill/弾導強化.jpg"),"死中に活":x("img/templates/skill/死中に活.jpg"),"気絶耐性":x("img/templates/skill/気絶耐性.jpg"),"泡沫の舞":x("img/templates/skill/泡沫の舞.jpg"),"泥雪耐性":x("img/templates/skill/泥雪耐性.jpg"),"滑走強化":x("img/templates/skill/滑走強化.jpg"),"火事場力":x("img/templates/skill/火事場力.jpg"),"睡眠耐性":x("img/templates/skill/睡眠耐性.jpg"),"砲弾装填":x("img/templates/skill/砲弾装填.jpg"),"翔蟲使い":x("img/templates/skill/翔蟲使い.jpg"),"装填拡張":x("img/templates/skill/装填拡張.jpg"),"装填速度":x("img/templates/skill/装填速度.jpg"),"速射強化":x("img/templates/skill/速射強化.jpg"),"鈍器使い":x("img/templates/skill/鈍器使い.jpg"),"風圧耐性":x("img/templates/skill/風圧耐性.jpg"),"飛び込み":x("img/templates/skill/飛び込み.jpg"),"高速変形":x("img/templates/skill/高速変形.jpg"),"麻痺耐性":x("img/templates/skill/麻痺耐性.jpg"),"回避距離UP":x("img/templates/skill/回避距離UP.jpg"),"ひるみ軽減":x("img/templates/skill/ひるみ軽減.jpg"),"ガード強化":x("img/templates/skill/ガード強化.jpg"),"ガード性能":x("img/templates/skill/ガード性能.jpg"),"攻めの守勢":x("img/templates/skill/攻めの守勢.jpg"),"毒属性強化":x("img/templates/skill/毒属性強化.jpg"),"笛吹き名人":x("img/templates/skill/笛吹き名人.jpg"),"精霊の加護":x("img/templates/skill/精霊の加護.jpg"),"腹減り耐性":x("img/templates/skill/腹減り耐性.jpg"),"体力回復量UP":x("img/templates/skill/体力回復量UP.jpg"),"キノコ大好き":x("img/templates/skill/キノコ大好き.jpg"),"ジャンプ鉄人":x("img/templates/skill/ジャンプ鉄人.jpg"),"スタミナ奪取":x("img/templates/skill/スタミナ奪取.jpg"),"フルチャージ":x("img/templates/skill/フルチャージ.jpg"),"剥ぎ取り鉄人":x("img/templates/skill/剥ぎ取り鉄人.jpg"),"抜刀術【力】":x("img/templates/skill/抜刀術【力】.jpg"),"抜刀術【技】":x("img/templates/skill/抜刀術【技】.jpg"),"爆破属性強化":x("img/templates/skill/爆破属性強化.jpg"),"特殊射撃強化":x("img/templates/skill/特殊射撃強化.jpg"),"睡眠属性強化":x("img/templates/skill/睡眠属性強化.jpg"),"麻痺属性強化":x("img/templates/skill/麻痺属性強化.jpg"),"会心撃【属性】":x("img/templates/skill/会心撃【属性】.jpg"),"属性やられ耐性":x("img/templates/skill/属性やられ耐性.jpg"),"水属性攻撃強化":x("img/templates/skill/水属性攻撃強化.jpg"),"氷属性攻撃強化":x("img/templates/skill/氷属性攻撃強化.jpg"),"火属性攻撃強化":x("img/templates/skill/火属性攻撃強化.jpg"),"爆破やられ耐性":x("img/templates/skill/爆破やられ耐性.jpg"),"砥石使用高速化":x("img/templates/skill/砥石使用高速化.jpg"),"雷属性攻撃強化":x("img/templates/skill/雷属性攻撃強化.jpg"),"龍属性攻撃強化":x("img/templates/skill/龍属性攻撃強化.jpg"),"アイテム使用強化":x("img/templates/skill/アイテム使用強化.jpg"),"スタミナ急速回復":x("img/templates/skill/スタミナ急速回復.jpg"),"散弾・拡散矢強化":x("img/templates/skill/散弾・拡散矢強化.jpg"),"貫通弾・貫通矢強化":x("img/templates/skill/貫通弾・貫通矢強化.jpg"),"通常弾・連射矢強化":x("img/templates/skill/通常弾・連射矢強化.jpg")}},this.templates.page={};for(let t=1;t<=this.MAX_PAGE;t++)this.templates.page[t]=x(`img/templates/page/${t}.png`);this.templates=await C(this.templates),this.reset()}reset(){this.nCharms=0,this.charms={};for(let t=1;t<=this.MAX_PAGE;t++){this.charms[t]={};for(let e=1;e<=this.ROWS_PER_PAGE;e++)this.charms[t][e]={}}}isScaned(t,e,l){return null!=this.charms[t][e][l]}store(t){const{page:e,row:l,col:s}=t;this.charms[e][l][s]=t,this.nCharms++}scan(t){const e=this._getCurrentPage(t),[l,s]=this._getCurrentCharmPos(t);if(s<.35)return null;const[i,n]=l;if(this.isScaned(e,n,i))return null;const m=this._getRarity(t),a=this._getSlots(t),p=this._getSkills(t),g=this._getSkillLevels(t);console.log(`scaned ${n} ${i}`),this.store({page:e,row:n,col:i,rarity:m,slots:a,skills:p,skillLevels:g})}countCharms(){return this.nCharms}generateInsertScript(){const t=[];for(let e=1;e<=this.MAX_PAGE;e++)for(let l=1;l<=this.ROWS_PER_PAGE;l++)for(let s=1;s<=this.COLUMNS_PER_PAGE;s++){const i=this.charms[e][l][s];null!=i&&t.push({"第一スキル":i.skills[0],"第一スキルポイント":i.skillLevels[0],"第二スキル":i.skills[1],"第二スキルポイント":i.skillLevels[1],"スロット":i.slots})}return`const inputs = ${JSON.stringify(t)}\n\neval( await (await fetch('https://code.jquery.com/jquery-3.6.0.slim.min.js')).text() )\n\nfor (const input of inputs) {\n  Object.entries(input).forEach(([key, value]) => {\n    $(\`select[aria-label="\${key}"]\`).val(value)\n    $(\`select[aria-label="\${key}"]\`)[0].dispatchEvent(new Event('change', { bubbles: true }))\n  })\n\n  $('button:contains("追加")').click()\n}`}_getRarity(t){return I(t,this.templates.rare,this.POINT_RARITY,63,63)}_getSlots(t){return I(t,this.templates.slot,this.POINT_SLOTS,0,63)}_getSkills(t){return[I(t,this.templates.skill,this.POINT_SKILL1,0,63),I(t,this.templates.skill,this.POINT_SKILL2,0,63)]}_getSkillLevels(t){return[I(t,this.templates.lvl,this.POINT_SKILL_LEVEL1,0,63),I(t,this.templates.lvl,this.POINT_SKILL_LEVEL2,0,63)]}_getCurrentPage(t){return I(t,this.templates.page,this.POINT_PAGE,31,63)}_getCurrentCharmPos(t){const e=new cv.Rect(this.POINT_CHARM_AREA_LEFT_TOP,this.SIZE_CHARM_AREA),l=t.roi(e),s=new cv.Mat;cv.matchTemplate(l,this.templates.frame,s,cv.TM_CCOEFF_NORMED);const{maxLoc:i,maxVal:n}=cv.minMaxLoc(s);return s.delete(),l.delete(),[[1+Math.floor(.5+i.x/36),1+Math.floor(.5+i.y/41)],n]}}const N=[];function G(t){let e,l,s,i,n,m,u,k,f,d,v=Math.floor(100*t[9])+"";return{c(){e=c("div"),l=c("video"),s=c("track"),n=o(),m=c("div"),u=c("progress"),k=o(),f=r(v),d=r("%"),h(s,"kind","captions"),h(l,"class","preview svelte-1mc31xc"),l.src!==(i=t[5])&&h(l,"src",i),h(l,"alt","preview"),u.value=t[9],h(u,"class","svelte-1mc31xc"),h(e,"id","status"),h(e,"class","svelte-1mc31xc")},m(i,g){p(i,e,g),a(e,l),a(l,s),t[12](l),a(e,n),a(e,m),a(m,u),a(m,k),a(m,f),a(m,d)},p(t,e){32&e&&l.src!==(i=t[5])&&h(l,"src",i),512&e&&(u.value=t[9]),512&e&&v!==(v=Math.floor(100*t[9])+"")&&j(f,v)},d(l){l&&g(e),t[12](null)}}}function K(e){let l;return{c(){l=c("div"),l.textContent="Loading Files..."},m(t,e){p(t,l,e)},p:t,d(t){t&&g(l)}}}function H(e){let l,i,n,m,r,j,k,f,d;return{c(){var t,e,s;l=c("div"),i=c("input"),n=o(),m=c("img"),j=o(),k=c("div"),k.textContent="Choose Movie",t="display",e="none",i.style.setProperty(t,e,s?"important":""),h(i,"type","file"),h(i,"accept",".mp4"),h(i,"class","svelte-1mc31xc"),m.src!==(r="https://static.thenounproject.com/png/625182-200.png")&&h(m,"src","https://static.thenounproject.com/png/625182-200.png"),h(m,"alt",""),h(m,"class","svelte-1mc31xc"),h(k,"class","svelte-1mc31xc"),h(l,"id","upload"),h(l,"class","svelte-1mc31xc")},m(t,s){p(t,l,s),a(l,i),e[15](i),a(l,n),a(l,m),a(l,j),a(l,k),f||(d=[u(i,"change",e[13]),u(i,"change",e[14]),u(m,"click",e[16]),u(k,"click",e[17])],f=!0)},p:t,d(t){t&&g(l),e[15](null),f=!1,s(d)}}}function U(t){let e,l,s,i,n;return{c(){e=c("div"),l=r(t[6]),s=r(" charms are scanned."),i=o(),n=c("textarea"),n.value=t[8],h(n,"class","svelte-1mc31xc")},m(m,g){p(m,e,g),a(e,l),a(e,s),p(m,i,g),p(m,n,g),t[18](n)},p(t,e){64&e&&j(l,t[6]),256&e&&(n.value=t[8])},d(l){l&&g(e),l&&g(i),l&&g(n),t[18](null)}}}function F(e){let l,s,i,n,m,r,u=e[5]&&G(e);function j(t,e){return t[0]?H:K}let k=j(e),f=k(e),d=e[1]&&U(e);return{c(){l=c("main"),s=c("h1"),s.textContent=`${V}`,i=o(),u&&u.c(),n=o(),f.c(),m=o(),r=c("div"),d&&d.c(),h(s,"class","svelte-1mc31xc"),h(r,"id","result"),h(r,"class","svelte-1mc31xc"),h(l,"class","svelte-1mc31xc")},m(t,e){p(t,l,e),a(l,s),a(l,i),u&&u.m(l,null),a(l,n),f.m(l,null),a(l,m),a(l,r),d&&d.m(r,null)},p(t,[e]){t[5]?u?u.p(t,e):(u=G(t),u.c(),u.m(l,n)):u&&(u.d(1),u=null),k===(k=j(t))&&f?f.p(t,e):(f.d(1),f=k(t),f&&(f.c(),f.m(l,m))),t[1]?d?d.p(t,e):(d=U(t),d.c(),d.m(r,null)):d&&(d.d(1),d=null)},i:t,o:t,d(t){t&&g(l),u&&u.d(),f.d(),d&&d.d()}}}const V="MHRise Charm Scanner";function X(e,l,s){let i,a,p,g,c,r,o,u,h,j,k=!1,f=!1;const d=function(e,l=t){let s;const i=[];function m(t){if(n(e,t)&&(e=t,s)){const t=!N.length;for(let t=0;t<i.length;t+=1){const l=i[t];l[1](),N.push(l,e)}if(t){for(let t=0;t<N.length;t+=2)N[t][0](N[t+1]);N.length=0}}}return{set:m,update:function(t){m(t(e))},subscribe:function(n,a=t){const p=[n,a];return i.push(p),1===i.length&&(s=l(m)||t),n(e),()=>{const t=i.indexOf(p);-1!==t&&i.splice(t,1),0===i.length&&(s(),s=null)}}}}(0);m(e,d,(t=>s(9,i=t)));const _=async t=>{const e=t.target.files;if(e&&e[0]){const t=new FileReader;t.readAsDataURL(e[0]),await new Promise((e=>{t.onload=e})),s(5,r=t.result),await new Promise((t=>setTimeout(t,50))),s(4,c.width=1280,c),s(4,c.height=720,c),await new Promise((t=>c.addEventListener("canplay",t))),o=new cv.VideoCapture(c);const l=new cv.Mat(720,1280,cv.CV_8UC4);await new Promise((t=>setTimeout(t,200)));const i=29.97;for(;c.duration!=c.currentTime;)o.read(l),a.scan(l),P(c,1,i),d.set(c.currentTime/c.duration),await new Promise((t=>setTimeout(t,100)));d.set(1),console.log(a.charms),s(1,f=!0),l.delete()}s(6,u=a.countCharms()),s(8,j=a.generateInsertScript())};window.addEventListener("load",(async()=>{a=new M,await a.init(),s(0,k=!0)}));const P=(t,e,l=29.97)=>{const s=1e-5+(t.currentTime*l+e)/l;t.currentTime=Math.min(t.duration,s)};return[k,f,p,g,c,r,u,h,j,i,d,_,function(t){v[t?"unshift":"push"]((()=>{c=t,s(4,c)}))},t=>_(t),function(){g=this.files,s(3,g)},function(t){v[t?"unshift":"push"]((()=>{p=t,s(2,p)}))},()=>{p.click()},()=>{p.click()},function(t){v[t?"unshift":"push"]((()=>{h=t,s(7,h)}))}]}return new class extends class{$destroy(){!function(t,e){const l=t.$$;null!==l.fragment&&(s(l.on_destroy),l.fragment&&l.fragment.d(e),l.on_destroy=l.fragment=null,l.ctx=[])}(this,1),this.$destroy=t}$on(t,e){const l=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return l.push(e),()=>{const t=l.indexOf(e);-1!==t&&l.splice(t,1)}}$set(t){var e;this.$$set&&(e=t,0!==Object.keys(e).length)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}{constructor(t){super(),S(this,t,X,F,n,{})}}({target:document.body,props:{}})}();
//# sourceMappingURL=bundle.js.map
